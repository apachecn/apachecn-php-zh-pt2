# 8.多功能接口

Electronic supplementary material The online version of this chapter (doi:[10.​1007/​978-1-4842-1730-6_​8](http://dx.doi.org/10.1007/978-1-4842-1730-6_8)) contains supplementary material, which is available to authorized users.

努力工作不会导致死亡，但为什么要冒险呢—埃德加·伯根( [`http://coolfunnyquotes.com`](http://coolfunnyquotes.com) )

## 章节目标/学生学习成果

完成本章后，学生将能够:

*   创建一个完整的 PHP 应用程序来删除、更新和插入数据
*   使用 CSS 创建完整应用程序的专业外观
*   使用 JavaScript 接受和操作来自另一个程序的数据
*   保护需要用户 id/密码的应用程序中的所有程序
*   用 JSON 对象的值填充 HTML 对象
*   创建一个使用当前密码加密技术的 PHP 程序

## 完整的应用程序

在本章中，您将完成 ABC 犬类收容所预订系统的开发。该系统的当前版本允许用户仅插入一只狗，然后要求他们再次登录以插入额外的狗。此外，该系统不允许用户更新或删除系统中存在的狗信息。在第 6 章(数据对象)中，你已经完成了提供更新和删除功能所需的大部分 PHP 代码。您现在需要将数据对象的这一部分(`dog_data`)附加到业务规则层(`dog`)。此外，您需要对接口层(`dog_interface`和`lab`)进行一些更改，以调用`update`和`delete`方法并显示结果。所需的大部分编码(您很快就会看到)将发生在`lab.php`文件中。所以你将从这些改变开始。

## 使用 JavaScript 的数据处理

当前的`lab.php`文件只允许用户输入将被插入数据存储(XML、JSON 或 MySQL)的狗的信息。该界面需要修改，以允许用户指出他们想完成什么活动(`Insert`、`Update`或`Delete`)。它还需要允许用户选择一个当前的狗，如果这个过程涉及更新或删除。这应该，希望，表明你将需要一个列表框，其中填充了当前位于收容所的狗的信息。

在本章的后面几节中，你将会看到 PHP 的必要修改。现在，让我们假设`dog_interface`(接口层)将返回该信息，该信息是通过`dog`方法(业务规则层)从`dog_data`(数据层)检索的。你还将假设类似的编码`dog_breeds`程序([第 4 章](4.html))将被创建来产生一个狗列表框。

此外，`lab.php`需要访问被选中的特定狗的所有信息。代码需要将所有信息放在`dog_name`和`dog_weight`文本框、`dog_breeds`列表框和`dog_color`单选按钮中。你可以用两种方式完成这项任务。一种是允许用户从列表框中选择狗，然后调用`dog_interface`程序从狗类中请求特定的狗，这又会从`dog_data`类中请求信息。然而，这需要通过互联网进行额外的、不必要的呼叫来请求信息。相反，您可以在用户第一次调用`lab.php`接口时收集所有必要的信息(`dog_breed`列表框信息、`dogs`列表框信息以及当前数据存储中所有狗的完整信息)。您可以使用当前的 JavaScript AJAX 代码([第 4 章](4.html))进行一些修改来检索所有必要的信息。

在填充表单对象(文本框、列表框和单选按钮)之前，您必须确保用户指明请求的操作类型(至少是插入或更改/删除)。您可以通过在做出选择之前不显示表单对象来实现这一点。您可以对第 4 章中使用的 JavaScript 代码和 CSS 代码的组合稍作调整，要求用户在显示表单之前从狗列表框中进行选择。

Note

您将要看到的过程是 web 应用程序中非常常见的实践。许多 web 应用程序以数组、JSON 或 XML 格式返回数据。然后，接口(在本例中为`lab.php`)可以使用 JavaScript 来检索所需的信息。

编程注意事项——购物车使用类似的技术。当顾客选择要购买的商品时，这些商品被放在客户机上的一个数据对象(可能是一个 JSON 对象)中。当顾客开始结账时，数据被传输到服务器。这允许客户进行不会导致对服务器的额外调用的更改。由于购买信息不被视为安全风险，这通常是一个安全的过程。当然，这不是处理信用卡信息的好方法。

使用图 [8-1](#Fig1) 所示的格式，用户被迫在继续之前从列表框中选择`NEW`或一只狗。一旦用户做出选择，HTML 表单可以显示默认值(对于插入)或所选狗的当前值。CSS 代码最初会将按钮(和表单)显示为`"none"`。JavaScript 代码(您很快就会看到)会将正确按钮和表单的显示更改为`"inline"`，以便在适当的时候显示。

![A978-1-4842-1730-6_8_Fig1_HTML.jpg](A978-1-4842-1730-6_8_Fig1_HTML.jpg)

图 8-1。

The lab.php file with dogs list box

图 [8-2](#Fig2) 展示了用户选择新建时的结果。如前几章所示，提供了相同的默认值。唯一的视觉变化是输入按钮的文本。当用户没有启用 JavaScript 时，这种方法就会出现弱点。对于本例，如果没有启用 JavaScript，您将需要输入所有信息。您可以从`dog_data`类请求单只狗的信息(通过`Dog`类)。虽然这种方法不如您将要使用的 JavaScript 方法高效，但它比要求输入所有信息更方便用户。

![A978-1-4842-1730-6_8_Fig2_HTML.jpg](A978-1-4842-1730-6_8_Fig2_HTML.jpg)

图 8-2。

The lab.php file with NEW selected

图 [8-3](#Fig3) 显示了选择现有狗的结果。列表框显示狗的名字和品种(使其尽可能独特)。此外，还可以提供狗 ID 来识别特定的狗。当狗被选中时，狗的信息(`dog_name`、`dog_color`、`dog_weight`和`dog_breed`)被填充到表格中。然后，用户可以更新或删除狗的信息。

![A978-1-4842-1730-6_8_Fig3_HTML.jpg](A978-1-4842-1730-6_8_Fig3_HTML.jpg)

图 8-3。

The lab.php file with a dog selected Note

如前几章所述，本例中提供的代码不限制重复条目。因此，在真实环境中，需要使用一个附加字段(狗 ID)来使狗具有唯一性。

以前，当发生`insert`时，系统会显示一条消息，表明更改成功。如果需要另一个更改，用户需要重新加载`lab.php`文件。您可以通过让`dog_interface`程序用要返回的消息设置一个会话属性来解决这个问题。然后，`dog_interface`可以调用`lab.php`文件，后者可以检查是否有消息要显示。

![A978-1-4842-1730-6_8_Fig4_HTML.jpg](A978-1-4842-1730-6_8_Fig4_HTML.jpg)

图 8-4。

The lab.php file handling message from dog_interface

您将使用 PHP 代码、JavaScript 代码和 CSS 代码的组合来创建想要的结果。我们来分解一下。

`<?php`

`session_start();`

`if ((!isset($_SESSION['username'])) || (!isset($_SESSION['password']))) {`

`echo "You must login to access the ABC Canine Shelter Reservation System";`

`echo "<p>";`

`echo "<a href='e8login.php'>Login</a> | <a href='e8register.php'>Create an account</a>";`

`echo "</p>";`

`}`

`else if(($_SERVER['HTTP_REFERER'] == '`[`http://127.0.0.1:8080/mysite/bgchapter8/ExampleFile8/e8login.php`](http://127.0.0.1:8080/mysite/bgchapter8/ExampleFile8/e8login.php)`') || ($_SERVER['HTTP_REFERER'] == '`[`http://127.0.0.1:8080/mysite/bgchapter8/ExampleFile8/e8lab.php`](http://127.0.0.1:8080/mysite/bgchapter8/ExampleFile8/e8lab.php)T4】

`{`

`if (isset($_SESSION['message'])) {`

`echo $_SESSION['message'];`

`}`

`else {`

`echo "<p>Welcome back, " . $_SESSION['username'] . "</p>";`

`}`

`?>`

实验程序顶部的 PHP 代码现在将包括一个额外的检查，以确定是否有消息被返回。虽然语句的`if`部分不需要任何修改，但是`else`部分有一些额外的修改。注意，新的`if`语句检查实验室程序是否被自己调用。当`dog_interface`使用`header`方法调用`lab.php`时，`$_SERVER['HTTP_REFERER']`方法返回`lab.php`作为调用程序。此外，同一个`if`语句还检查`login.php`是否调用了`lab`。现在只有这两个合法的调用可以调用`lab.php`程序。

`else`块中的另一个`if`语句检查是否通过使用`isset`方法返回了一个`$_SESSION['message']`。如果已经返回，那么`lab.php`是被`dog_interface`调用的，因为登录不返回一个`$_SESSION['message']`。实验室程序现在显示消息。如果没有`$_SESSION['message']`，则显示欢迎消息。

现在让我们跳到`lab.` `php`中的 HTML 代码。然后，您将看一看 CSS 和 JavaScript 代码。

`<body onload="checkJS();">`

`<h1>ABC Canine Shelter Reservation System</h1>`

`<div id="JS">`

`<script>`

`AjaxRequest('e8dog_interface.php');`

`</script>`

`<h3>Pick the dog name and breed to change from the dropdown box, then click the button.<br>For new dog information select 'NEW'.</h3>`

`Select 'NEW' or Dog's Name/Breed <div id="AjaxReturnValue"></div>`

`<input type="button" name="selected" id="selected" value="Click to select" onclick="process_select()" /><br><br>`

`<div id="input_form">`

`<form method="post" action="e8dog_interface.php" onSubmit="return validate_input(this)">`

`<h3>Please note the required format of information.</h3>`

`<hr>`

`Enter Your Dog's Name (max 20 characters, alphabetic) <input type="text" pattern="[a-zA-Z]*"  title="Up to 20 Alphabetic Characters" maxlength="20" name="dog_name" id="dog_name" required/><br /><br />`

`Select Your Dog's Color:<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Brown">Brown<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Black">Black<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Yellow">Yellow<br />`

`<input type="radio" name="dog_color" id="dog_color" value="White">White<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Mixed" checked >Mixed<br /><br />`

`Enter Your Dog's Weight (numeric only) <input type="number" min="1" max="120" name="dog_weight" id="dog_weight" required /><br /><br />`

`<input type="hidden" name="dog_app" id="dog_app" value="dog" />`

`Select Your Dog's Breed <div id="AjaxResponse"></div><br />`

`<input type="hidden" name="index" id="index" value="-1"/>`

`<input type="submit" name="insert" id="insert" value="Click to create your dog info" />`

`<input type="submit" name="delete" id="delete" value="Click to remove your selected dog info" />`

`<input type="submit" name="update" id="update" value="Click to update your selected dog info" />`

`<hr>`

`</form>`

`</div>`

`</div>`

除了一些小的显示消息变化之外，还创建了一个 ID 为`AjaxReturnValue`的新的`div`标签来保存狗列表框(它将为用户提供狗的选择)。随后是一个 HTML 按钮(不是提交按钮)。当点击时，它将导致一个 JavaScript 函数(`process_select`)执行。添加了另一个包含 HTML 表单的`div`标签。该表单将被隐藏，直到用户单击该按钮。

CSS 代码(`#input_form { display:none; }`)包含在程序的顶部，以防止表单显示。额外的 CSS 代码也阻止按钮显示。这段代码非常类似于 CSS 代码，如果用户没有在浏览器中激活 JavaScript，它会阻止非 JS 表单的显示。

在表单的底部，创建了一个隐藏属性(`index`)来保存所选狗的索引(来自狗数组)。初始值设定为`-1`。当用户选择一只狗时，这个属性将被改变。原来的 Submit 按钮被三个 Submit 按钮取代(一个用于插入，一个用于删除，一个用于更新)。无论点击哪个按钮，都会创建一个属性(`insert`、`delete`或`update`)并设置一个值。属性名是按钮的 ID，属性中的内容是选中按钮的`value`属性的内容。这将有助于`dog_interface`确定用户请求哪种类型的更改。这些按钮也包含在不支持 JavaScript 的表单中。请记住，在本例中，不支持 JavaScript 的浏览器将要求用户输入成功完成`insert`、`delete`或`update`所需的所有信息。

希望你刚才看到的变化是可以理解的。您现在将看到一些处理这些数据的 JavaScript 代码。如前所述，JavaScript 对数据的操作是 web 应用程序中的常见任务。虽然这不是一本 JavaScript 书，但是任何 web 应用程序开发人员熟悉 JavaScript 都是很重要的。我想你会看到 JavaScript 语言的结构和 PHP 语言的结构很相似。

首先你会看到对`get_breeds.js`文件的修改(来自[第 4 章](4.html))。该文件被重命名为`getlists.js`，以反映它现在将处理`getBreeds`和`dogs`列表框。

`function HandleResponse(response)`

`{`

`var responsevalues = response.split('|');`

`document.getElementById('AjaxResponse').innerHTML = responsevalues[0];`

`document.getElementById('AjaxReturnValue').innerHTML = responsevalues[1];`

`obj = JSON.parse(responsevalues[2]);`

`}`

所有的代码更改都在 JavaScript 文件的`HandleResponse`方法中。以前，响应属性中的值(传递给方法)被直接传递给带有`AjaxResponse` ID 的`div`标记。此时，只返回品种的列表框代码。现在，该方法将接受三种类型的信息(品种列表框、狗列表框和狗数组)。为了减少对 web 服务器的调用次数，进行了一次 AJAX 调用。它将所有信息返回到`response`属性中。信息将使用管道符号(`|`)分隔。很快你就会看到这个字符串的形成会发生在`dog_interface`程序中。

您将需要以类似于使用 PHP `explode`方法破坏先前数据的方式来破坏数据。在 JavaScript 中，`split`方法将使用提供的参数(`|`)将一个字符串分解成一个数组。在示例中，这将创建数组 responsevalues。`var`将该数组创建为该方法的本地数组。当方法关闭时(点击`}`符号)，它将被销毁，因为不再需要它了。该数组现在有三行。第一行(`[0]`)包含`getBreeds`列表框代码。第二行(`[1]`)包含`dogs`列表框代码。第三行(我猜您已经猜到了)包含完整的 dogs 数组。

> And security-in this application, the dog information is not highly sensitive. In addition, information is displayed to the user. This allows users to view and repair any data that may be corrupted. For more sensitive information, the array should be declared with `var` to keep the data accessible only by the current method (function).

下标(0、1 和 2)现在可以用来拖动数组的每个部分，并将其释放到适当的位置。`responsevalues[0]`放在`AjaxResponse`中显示`getBreeds`列表。`responsevalues[1]`放置在`AjaxReturnValue`中，显示狗狗列表框。dogs 数组，因为您还不知道用户选择了哪只狗，所以它将被放在一个 JSON 对象中(`obj`)。如您所见，JSON 数据包括命名索引和值，这与 PHP 中的关联数组非常相似。没有使用`var`语句，因为这个对象必须是公共的，并且对整个应用程序可用。

如果你还记得前面的章节，数组不能直接格式化成字符串。数组必须序列化。但是，JSON 数据也可以在字符串中传递。您将很快看到`responsevalues[3]`中的“数组”已经被`dog_interface`程序格式化为 JSON 数据。JavaScript 的`JSON.parse`方法能够查看数据，如果数据有效，就将其转换成 JSON 对象。这与 PHP 方法`json_encode`非常相似。

现在让我们看看当用户从狗列表框中选择一只狗时，如何填充表单。

JavaScript 方法`process_select`(在用户从狗列表中选择后由 HTML 按钮调用)被放置在`lab.php`文件中代码的顶部。它也可以放在自己的 JS 文件中，并以与`getlists.js`文件相同的方式导入。这个新方法使用包含在 OBJ(包含所有狗的 JSON dogs 对象)中的信息，用用户在列表框中选择的狗的信息填充文本框(`dog_name`和`dog_weight`)、单选按钮(`dog_color`)和列表框(`dog_breed`)。

`function process_select() {`

`var colorbuttons = document.getElementsByName('dog_color');`

首先，所有单选按钮的颜色值将从 HTML 表单中提取出来，并放入一个名为`colorbuttons`的数组中，使用 JavaScript 方法`getElementsByName. dog_color`(每个单选按钮的名称)传递到该方法中。该过程将创建一个单选按钮数组，其索引与颜色的单选按钮下标相同。例如，数组的`0`位置现在将包含`brown`，这是 HTML 表单中显示的第一个单选按钮。这将允许您通过参考其位置来设置适当的颜色单选按钮(例如`colorbuttons[0]`来设置`brown`)。

`if(!(document.getElementById('dogs').value == -1))`

`{`

`index = document.getElementById('dogs').selectedIndex -1;`

`document.getElementById('index').value = index;`

`document.getElementById('dog_name').value = obj.dogs[index].dog_name;`

`document.getElementById('dog_weight').value = obj.dogs[index].dog_weight;`

HTML 列表框包括文本和值。文本是用户看到的；价值就是它所代表的东西。这非常类似于 PHP 关联数组——键(索引)和值。`if`语句检查 dogs 数组以确定其当前值。如果值为`-1`，这表明用户没有选择任何内容，或者他们选择了新建。JavaScript `!`符号与 PHP `!`符号的工作原理相同。当`'dogs'`的值不是`-1`时，该符号改变要执行的语句的`if`部分。因此，如果用户从狗列表框中选择了一只狗，代码就会执行。

列表框的`selectedIndex`属性表示用户选择的索引。但是，HTML 列表框从 1 开始编号。JavaScript 数组和 JSON 对象索引从 0 开始。这导致`selectedIndex`比 JavaScript 数组或 JSON 对象中的位置多 1。该示例中的代码减去 1 以平衡该关系。该值放在索引中。它也以相同的名称(`index`)保存在隐藏属性中(在 HTML 表单上)。由于`index`是一个属性而不是一个`div`标签，JavaScript `value`属性必须用来设置 index 的值。

`obj`是 AJAX 调用发生时创建的 JSON 对象(包含所有的狗)。可以用与 PHP 关联数组非常相似的方式从 JSON 对象中检索信息。`obj`对象类似于前面章节中显示的多维 dogs 数组。最上面的阵列是狗的“阵列”。在狗数组中是每只狗的“数组”。这些没有相关的键名，但有一个数字索引。每个狗数组包含单独的元素(`dog_name`、`dog_color`、`dog_breed`和`dog_weight`)。在前面的代码行中设置的`index`属性包含用户选择的狗索引。它将用于从`obj`中提取选定的狗信息，以填充表单对象。

因为您知道要检索的数据的确切位置(在索引中)，所以不需要循环。

`obj.dogs[index].dog_name`使用 JSON 对象名(`obj`)、顶层数组名(`dogs`)、所需 dog 数组的编号(`index`)和所需字段的名称(`dog_name`)来访问所需信息。同样，这种格式类似于从 PHP 关联数组中提取信息。`dog_name`和`dog_weight`值使用这种点符号格式从`obj` JSON 对象中提取信息，并将其放入 HTML 表单上适当的文本框中。

`dog_color = obj.dogs[index].dog_color;`

`if(dog_color == "Brown")`

`{`

`colorbuttons[0].checked = true;`

`} else if (dog_color == "Black")`

`{`

`colorbuttons[1].checked = true;`

`} else if (dog_color == "Yellow")`

`{`

`colorbuttons[2].checked = true;`

`} else if (dog_color == "White")`

`{`

`colorbuttons[3].checked = true;`

`}`

设置颜色需要更多的工作。从`obj`对象(`dog_color = obj.dogs[index].dog_color;`)中取出`dog_color`并放入属性(`dog_color`)中。然后使用一个`if`语句来确定这个属性中存在什么颜色。(是的，JavaScript 有一个`case`语句，您也可以使用它)。`if`语句将正确单选按钮的`checked`属性设置为`true`，导致单选按钮被选中。注意，默认值(`'mixed'`)不包括在`if`语句中。如果狗是`'mixed'`，或者由于某种原因颜色在对象中没有值，没有理由改变默认值(`'mixed'`)。

`dog_breed = obj.dogs[index].dog_breed;`

`document.getElementById('dog_breed').value = dog_breed;`

`document.getElementById('update').style.display = "inline";`

`document.getElementById('delete').style.display = "inline";`

`document.getElementById('insert').style.display = "none";`

`}`

使用与设置文本框相同的代码样式设置`breeds`列表框。属性设置用户查看的列表框文本。如果需要，用户可以更改该值。`"update"`和`"delete"`按钮设置为`"inline"`显示。`"Insert"`设置为`"none"`。

`else`

`{`

`colorbuttons[4].checked = true;`

`document.getElementById('dog_name').value = "";`

`document.getElementById('dog_weight').value = "";`

`document.getElementById('dog_breed').value = "Select a dog breed";`

`document.getElementById('insert').style.display = "inline";`

`document.getElementById('update').style.display = "none";`

`document.getElementById('delete').style.display = "none";`

`}`

如果索引是`-1`，则执行`if`语句的`else`部分(选择 NEW，或者不选择任何内容)。默认设置如下，如前面其他章节所示，颜色设置为`'mixed'`，名称和重量文本框为空，而`breeds`列表框设置为请求用户`Select a dog breed`。显示`"insert"`按钮(使用`"inline"`)。其他按钮不显示(使用`"none"`)。

`document.getElementById('input_form').style.display = "inline";`

`}`

最后，表单本身的显示(现在称为`input_form'`)被设置为`'inline'`，这将允许用户看到完整的表单及其值，就像前面的代码中设置的那样。让我们看看完整的代码。

Example 8-1\. The getlists.js file

`function AjaxRequest(value)`

`{`

`var xmlHttp = getXMLHttp();`

`xmlHttp.onreadystatechange = function()`

`{`

`if(xmlHttp.readyState == 4)`

`{`

`HandleResponse(xmlHttp.responseText);`

`}`

`}`

`xmlHttp.open("GET", value, true);`

`xmlHttp.send(null);`

`}`

`function HandleResponse(response)`

`{`

`var responsevalues = response.split('|');`

`document.getElementById('AjaxResponse').innerHTML = responsevalues[0];`

`document.getElementById('AjaxReturnValue').innerHTML = responsevalues[1];`

`obj = JSON.parse(responsevalues[2]);`

`}`

`function getXMLHttp()`

`{`

`var xmlHttp;`

`try {`

`xmlHttp = new XMLHttpRequest();`

`}`

`catch(e)`

`{`

`//Internet Explorer is different than the others`

`Try {`

`xmlHttp = new ActiveXObject("Msxml2.XMLHTTP");`

`}`

`catch(e)  {`

`try {`

`xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");`

`}`

`catch(e)`

`{`

`alert("Old browser? Upgrade today so you can use AJAX!")`

`return false;`

`}`

`}`

`}`

`return xmlHttp;`

`}`

Example 8-2\. The lab.php file with update, insert, and delete

`<?php`

`session_start();`

`if ((!isset($_SESSION['username'])) || (!isset($_SESSION['password']))) {`

`echo "You must login to access the ABC Canine Shelter Reservation System";`

`echo "<p>";`

`echo "<a href='elogin.php'>Login</a> | <a href='eregister.php'>Create an account</a>";`

`echo "</p>";`

`}`

`else if(($_SERVER['HTTP_REFERER'] == '`[`http://127.0.0.1:8080/mysite/bgchapter8/login.php`](http://127.0.0.1:8080/mysite/bgchapter8/login.php)`') || ($_SERVER['HTTP_REFERER'] == '`[`http://127.0.0.1:8080/mysite/bgchapter8/lab.php`](http://127.0.0.1:8080/mysite/bgchapter8/lab.php)T4】

`{`

`if (isset($_SESSION['message']))`

`{`

`echo $_SESSION['message'];`

`}`

`else`

`{`

`echo "<p>Welcome back, " . $_SESSION['username'] . "</p>";`

`}`

`?>`

`<!DOCTYPE html>`

`<html lan="en">`

`<head>`

`<title>ABC Canine Shelter Reservation System</title>`

`<script src="getlists.js"></script>`

`<script src="validator.js"></script>`

`<style type="text/css">`

`#JS { display:none; }`

`#insert {display: none; }`

`#delete {display: none; }`

`#update {display: none; }`

`#input_form { display:none; }`

`</style>`

`<script>`

`function checkJS() {`

`document.getElementById('JS').style.display = "inline"; }`

`function process_select() {`

`var colorbuttons = document.getElementsByName('dog_color');`

`if(!(document.getElementById('dogs').value == -1)) {`

`index = document.getElementById('dogs').selectedIndex -1;`

`document.getElementById('index').value = index;`

`document.getElementById('dog_name').value = obj.dogs[index].dog_name;`

`document.getElementById('dog_weight').value = obj.dogs[index].dog_weight;`

`dog_color = obj.dogs[index].dog_color;`

`if(dog_color == "Brown") {`

`colorbuttons[0].checked = true;`

`} else if (dog_color == "Black")  {`

`colorbuttons[1].checked = true;`

`} else if (dog_color == "Yellow")  {`

`colorbuttons[2].checked = true;`

`} else if (dog_color == "White")  {`

`colorbuttons[3].checked = true;         }`

`dog_breed = obj.dogs[index].dog_breed;`

`document.getElementById('dog_breed').value = dog_breed;`

`document.getElementById('update').style.display = "inline";`

`document.getElementById('delete').style.display = "inline";`

`document.getElementById('insert').style.display = "none";`

`} else {`

`colorbuttons[4].checked = true;`

`document.getElementById('dog_name').value = "";`

`document.getElementById('dog_weight').value = "";`

`document.getElementById('dog_breed').value = "Select a dog breed";`

`document.getElementById('insert').style.display = "inline";`

`document.getElementById('update').style.display = "none";`

`document.getElementById('delete').style.display = "none";}`

`document.getElementById('input_form').style.display = "inline"; }`

`</script>`

`</head>`

`<body onload="checkJS();">`

`<h1>ABC Canine Shelter Reservation System</h1>`

`<div id="JS">`

`<script>`

`AjaxRequest('e8dog_interface.php');`

`</script>`

`<h3>Pick the dog name and breed to change from the dropdown box, then click the button.<br>For new dog information select 'NEW'.</h3>`

`Select 'NEW' or Dog's Name/Breed <div id="AjaxReturnValue"></div>`

`<input type="button" name="selected" id="selected" value="Click to select" onclick="process_select()" /><br><br>`

`<div id="input_form">`

`<form method="post" action="dog_interface.php" onSubmit="return validate_input(this)">`

`<h3>Please note the required format of information.</h3>`

`<hr>`

`Enter Your Dog's Name (max 20 characters, alphabetic) <input type="text" pattern="[a-zA-Z]*"  title="Up to 20 Alphabetic Characters" maxlength="20" name="dog_name" id="dog_name" required/><br /><br />`

`Select Your Dog's Color:<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Brown">Brown<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Black">Black<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Yellow">Yellow<br />`

`<input type="radio" name="dog_color" id="dog_color" value="White">White<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Mixed" checked >Mixed<br /><br />`

`Enter Your Dog's Weight (numeric only) <input type="number" min="1" max="120" name="dog_weight" id="dog_weight" required /><br /><br />`

`<input type="hidden" name="dog_app" id="dog_app" value="dog" />`

`Select Your Dog's Breed <div id="AjaxResponse"></div><br />`

`<input type="hidden" name="index" id="index" value="-1"/>`

`<input type="submit" name="insert" id="insert" value="Click to create your dog info" />`

`<input type="submit" name="delete" id="delete" value="Click to remove your selected dog info" />`

`<input type="submit" name="update" id="update" value="Click to update your selected dog info" />`

`<hr>`

`</form>`

`</div>`

`</div>`

`<noscript>`

`<div id="noJS">`

`<form method="post" action="dog_interface.php">`

`<h3>For Updates please enter all fields. For Deletions enter at least the dog name and breed. Then click the button.<br>For new dog information enter the requested information, Then click the button.<br> Please note the required format of information.</h3>`

`Enter Your Dog's Name (max 20 characters, alphabetic) <input type="text" pattern="[a-zA-Z ]*"  title="Up to 20 Alphabetic Characters" maxlength="20" name="dog_name" id="dog_name" required/><br /><br />`

`Select Your Dog's Color:<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Brown">Brown<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Black">Black<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Yellow">Yellow<br />`

`<input type="radio" name="dog_color" id="dog_color" value="White">White<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Mixed" checked >Mixed<br /><br />`

`Enter Your Dog's Weight (numeric only) <input type="number" min="1" max="120" name="dog_weight" id="dog_weight" required /><br /><br />`

`Enter Your Dog's Breed (max 35 characters, alphabetic) <input type="text" pattern="[a-zA-Z ]*" title="Up to 15 Alphabetic Characters" maxlength="35" name="dog_breed" id="dog_breed" required /><br />`

`<input type="hidden" name="dog_app" id="dog_app" value="dog" />`

`<input type="submit" name="input" id="input" value="Click to create your dog info" />`

`<input type="submit" name="delete" id="delete" value="Click to remove your selected dog info" />`

`<input type="submit" name="update" id="update" value="Click to update your selected dog info" />`

`</form>`

`</div>`

`</noscript>`

`</body>`

`</html>`

之前显示的唯一没有提到的变化是删除了代码末尾的`session_destroy`。因为您希望`dog_interface`能够召回`lab.php`，所以会话需要一直处于活动状态，直到用户完成更改。在本章的后面，您将创建一个注销例程来关闭会话。

### 做它

Explain how PHP code can be used to replace the process that the JavaScript code uses to display the list boxes, determine which dog was selected, and populate the form objects with the information from the dog selected. This process would be necessary for any browsers that do not have JavaScript enabled. Hint: The PHP code will work in a very similar way to the JavaScript code. What changes would be necessary to the `dog_interface.php, dog.php`, and `dog_data.php` programs to accomplish this task?   Download the code for this section from the book’s web site. Adjust the code to handle dog information that will include the following additional fields: `dog_ID` (unique for each dog) and `dog_gender`. Assume that the `dog_interface.php`, `dog.php`, and `dog_data.php` file will return these fields. You won’t be able to completely test this assignment until you read about the changes to these programs.  

## 在接口层中更新、删除和插入

是时候看看界面和业务规则层中程序的变化了。数据层几乎不需要什么改变，因为以前创建的`dog_data`程序是为了处理狗信息的显示、更新、插入和删除。提前这样做可以使其他层所需的全部更改变得更加容易。

正如整本书所提到的，接口层负责格式化信息以供显示，并负责从业务规则层请求或处理信息。`dog_interface`程序应该接受来自数据层的 dogs 数组信息，如果需要的话，将其格式化以便在`lab.php`程序中使用。它还应该接受狗列表框的狗信息，为其提供任何格式，并将其发送到`lab.php`进行显示。此外，`dog_interface`必须接受来自`lab.php`的插入、更新和删除狗信息的请求，并将这些请求传递给数据层进行处理。这听起来可能很多，但是正如您将看到的，大多数编码已经存在于这些程序中。

首先让我们看一下将对`insert`或`update`的请求传递给数据层。

`$dog_color = clean_input($_POST['dog_color']);`

`$dog_weight = clean_input($_POST['dog_weight']);`

`$dog_index = clean_input($_POST['index']);`

`lab.php`文件将发送一个属性(`'index'`)到`dog_interface`。该属性将以与传递的其他属性相同的方式被接受和清理。

为请求传递给`insert`或`update`的信息类型几乎完全相同(所有的狗属性加上`'index'`)。因此，这些过程非常相似。您确实需要一种方法来指明请求的类型(`update`或`insert`)。

`if ((isset($_POST['insert'])) || (isset($_POST['update'])))`

`{`

`if (isset($_POST['insert']))`

`{`

`$insert = TRUE;`

`}`

`else`

`{`

`$insert = FALSE;`

`}`

您可以通过创建属性来实现这一点。在本例中，如果是插入请求，则`$insert`将被设置为`TRUE`，如果是`update`请求，则`FALSE`将被设置为`TRUE`。如果请求是一个`update`或`insert`，属性数组必须被填充。

`$properties_array = array($dog_name,$dog_breed,$dog_color,$dog_weight,$breedxml,$insert,$dog_index);`

您可以像以前在许多示例中一样创建`$properties_array`。一旦创建，它将被传递到`dog`类的一个实例中。唯一真正的变化是增加了`$insert`和`$dog_index`。`update`程序将使用`$dog_index`来指示要更改哪个记录。当有插入时，它将被设置为`-1`(由`lab.php`)，因为所有记录都被插入到数据的末尾。(你可以使用`-1`作为插入的指示器，而不是创建`$Insert`。)

`$lab = $container->create_object($properties_array);`

使用`$container`(它是已经在代码中创建的`dog_container`的一个实例)，`create_object`方法创建一个 dog 类的实例，并将属性数组传递给它。稍后，您将对`dog`类稍作修改，使用属性数组来确定是否应该调用来自`dog_data`的`insert`或`update`方法来完成请求。

`$_SESSION['message'] = "Dog $dog_name Insert/Update was successful<br />";`

如果`update`一切顺利，程序将设置`$_SESSION['message']`信息，然后由`lab.php`显示，而不是使用`echo`或`print`显示信息。

`header("Location: lab.php");`

应用程序然后被重定向回`lab.php. lab.php`将验证它是从`dog_interface`调用的，然后在页面顶部显示`"Dog $dog_name Insert/Update was successful<br />"`。(`$dog_name`替换为实际的狗名。)

如果请求是`delete`，则发生类似的过程。

`else if($_POST['delete'])`

`{`

`$properties_array = $dog_index;`

`dog_data delete`方法只需要数组中的位置来决定要删除什么。因此，`$properties_array`被设置为`$dog_index`中的值。尽管`$properties_array`现在是一个字符串而不是数组，但是`dog_data`中的`processRecords`方法使用多态性来接受数组或字符串。这使得代码非常类似于`update`和`insert`代码。

`$lab = $container->create_object($properties_array);`

`$_SESSION['message'] = "Dog $dog_name Deletion was successful<br />";`

`header("Location: lab.php");`

如`update`和`delete`所示，`$container`(已经创建的`dog_container`的一个实例)调用`create_object`方法来创建 dog 类的一个实例，并传递`$properties_array`(实际上是一个字符串)。如果删除成功，用`delete`消息设置`$_SESSION['message']`。然后调用`lab.php`程序。`lab.php`将验证`dog_container`调用了它，然后在页面顶部显示`"Dog $dog_name Deletion was successful<br />"`。(`$dog_name`替换为实际的狗名。)

为了处理插入、更新或删除请求，这些是`dog_interface`程序中唯一需要的代码更改。`dog_interface`还必须从数据层接受狗列表框和完整的狗数组，以格式化并发送给`lab.php`。

`dog_interface`必须通过调用`dog_data.php`中的显示方法来请求狗数组信息。

`$container = NULL;`

在返回品种列表的请求被处理后，容器指针`$container`可以被重用。通过将其设置为`NULL,`,它将释放当前的容器(一个`dog_container`的实例，其属性设置为检索品种信息)。

`$container = new dog_container("dog");`

一个新的`dog_container`实例通过`"dog"`而不是`"selectbox"`。这让容器知道将创建一个`dog`类的实例，而不是一个`breeds`类的实例。

`$properties = "dog";`

`$lab = $container->create_object($properties);`

当狗类的一个实例被`create_object`创建时，`dog`再次被传入以指示需要一个`dog`类的实例。

`$container->set_app("dog");`

`$dog_app = $container->get_dog_application("dog");`

`$method_array = get_class_methods($lab);`

`$last_position = count($method_array) - 1;`

`$method_name = $method_array[$last_position];`

`$returned_array = $lab->$method_name("ALL");`

用于调用`dog_data`中的`delete`、`insert`和`update`方法的相同代码用于调用显示方法。但是，`ALL`被传入而不是属性数组。`ALL`告诉`dog_data`显示方法返回所有的狗记录。由`dog_data`返回的所有记录都被放入`$return_array`中。

现在`dog_interface`已经有了所有的记录(在`$return_array`中)，它可以格式化代码来显示狗列表框。使用的代码类似于创建`breeds`列表框的代码。

`$resultstring = "<select name='dogs' id='dogs'>";`

`$resultstring = $resultstring . "<option value='-1' selected>NEW</option>";`

属性`$resultstring`将保存列表框的所有代码。首先创建一个 ID 为`'dogs'`的 HTML select 标记。然后，列表框的第一行被创建，以便用户选择 NEW，如果他们想要插入新的狗。请注意，NEW 的值是`-1`。这也是`lab.php`中 HTML 表单上隐藏属性`'index'`的默认值。你在本章前面看到的代码将确定`-1`是用狗信息的默认设置填充 HTML 表单对象的指示。无论用户选择新建还是不选择`dogs`列表框中的任何内容，都是如此。

`foreach ($returned_array as $column => $column_value)`

`{`

`$resultstring = $resultstring . "<option value='$column'>" . $column_value['dog_name'];`

`$resultstring .= “   " . $column_value['dog_breed'] . "</option>";`

`}`

`$resultstring = $resultstring . "</select>";`

一个`foreach`循环将遍历 dogs 数组(包含在`$returned_array`中),并使用数组中每个 dogs 条目的`dog_name`和`dog_breed`构建列表框的剩余行。当所有的狗都被放入列表框后，列表框使用 HTML `</select>`标签关闭。

`print $result . "|" . $resultstring . "|" . '{ "dogs" : ' . json_encode($returned_array) . "}";`

`lab.php`期望在第一个位置接收`breeds`列表框代码，在第二个位置接收`dogs`列表框代码，在第三个位置接收完整的 dogs 数组。`$result`已经包含了完整的品种列表框。`$resultstring`包含新的狗狗列表框。`$return_array`仍然包含所有的狗记录。`lab.php`期望 dogs 数组的外部数组被标记为`'dogs'`。`dog_data`的显示方法没有将外部数组传递回来。前面的代码将创建一个 dogs 数组，其中包含所有单个的 dogs 数组。注意，`$return_array`在返回时已经被转换成 JSON 代码。`lab.php`中的 JavaScript 代码将在收到时验证它是否是正确格式化的 JSON 代码。

我们来看完整的`dog_interface`程序。

Example 8-3\. The dog_interface.php file with update, insert, and delete

`<?php`

`session_start();`

`const USER_ERROR_LOG = "User_Errors.log";`

`const ERROR_LOG = "Errors.log";`

`function clean_input($value)`

`{`

`$value = htmlentities($value);`

`// Removes any html from the string and turns it into < format`

`$value = strip_tags($value);`

`if (get_magic_quotes_gpc())`

`{`

`$value = stripslashes($value);`

`// Gets rid of unwanted slashes`

`}`

`$value = htmlentities($value);`

`// Removes any html from the string and turns it into < format`

`$bad_chars = array( "{", "}", "(", ")", ";", ":", "<", ">", "/", "$" );`

`$value = str_ireplace($bad_chars,"",$value);`

`return $value;`

`}`

`class setException extends Exception {`

`public function errorMessage() {`

`list($name_error, $breed_error, $color_error, $weight_error) = explode(',', $this->getMessage());`

`$name_error == 'TRUE' ? $eMessage = '' : $eMessage = 'Name update not successful<br/>';`

`$breed_error == 'TRUE' ? $eMessage .= '' : $eMessage .= 'Breed update not successful<br/>';`

`$color_error == 'TRUE' ? $eMessage .= '' : $eMessage .= 'Color update not successful<br/>';`

`$weight_error == 'TRUE' ? $eMessage .= '' : $eMessage .= 'Weight update not successful<br/>';`

`return $eMessage;`

`}`

`}`

`function get_dog_app_properties($lab)`

`{`

`print "Your dog's name is " . $lab->get_dog_name() . "<br/>";`

`print "Your dog weights " . $lab->get_dog_weight() . " lbs. <br />";`

`print "Your dog's breed is " . $lab->get_dog_breed() . "<br />";`

`print "Your dog's color is " . $lab->get_dog_color() . "<br />";`

`}`

`//----------------Main Section-------------------------------------`

`try {`

`if ( file_exists("e8dog_container.php"))`

`{`

`Require_once("e8dog_container.php");`

`}`

`else`

`{`

`throw new Exception("Dog container file missing or corrupt");`

`}`

`if (isset($_POST['dog_app']))`

`{`

`if ((isset($_POST['dog_name'])) && (isset($_POST['dog_breed'])) && (isset($_POST['dog_color'])) && (isset($_POST['dog_weight'])))`

`{`

`$container = new dog_container(clean_input($_POST['dog_app']));`

`$dog_name = clean_input(filter_input(INPUT_POST, "dog_name"));`

`$dog_breed = clean_input($_POST['dog_breed']);`

`$dog_color = clean_input($_POST['dog_color']);`

`$dog_weight = clean_input($_POST['dog_weight']);`

`$dog_index = clean_input($_POST['index']);`

`$breedxml = $container->get_dog_application("breeds");`

`if ((isset($_POST['insert'])) || (isset($_POST['update'])))`

`{`

`if (isset($_POST['insert']))`

`{`

`$insert = TRUE;`

`}`

`else`

`{`

`$insert = FALSE;`

`}`

`$properties_array = array($dog_name,$dog_breed,$dog_color,$dog_weight,$breedxml,$insert,$dog_index);`

`$lab = $container->create_object($properties_array);`

`$_SESSION['message'] = "Dog $dog_name Insert/Update was successful<br />";`

`header("Location: e8lab.php");`

`//print "Dog $dog_name Insert/Update was successful<br />";`

`//get_dog_app_properties($lab);`

`}`

`else`

`{`

`$insert = FALSE;`

`}`

`$properties_array = array($dog_name,$dog_breed,$dog_color,$dog_weight,$breedxml,$insert,$dog_index);`

`$lab = $container->create_object($properties_array);`

`$_SESSION['message'] = "Dog $dog_name Insert/Update was successful<br />";`

`header("Location: e8lab.php");`

`//print "Dog $dog_name Insert/Update was successful<br />";`

`}`

`else if($_POST['delete'])`

`{`

`$properties_array = $dog_index;`

`$lab = $container->create_object($properties_array);`

`$_SESSION['message'] = "Dog $dog_name Deletion was successful<br />";`

`header("Location: e8lab.php");`

`//print "Dog $dog_name Deletion was successful<br />";`

`}`

`}`

`else`

`{`

`print "<p>Missing or invalid parameters. Please go back to the dog.php page to enter valid information.<br />";`

`print "<a href='e8lab.php'>Dog Creation Page</a>";`

`}`

`}`

`else // breeds select box`

`{`

`$container = new dog_container("selectbox");`

`$properties_array = array("selectbox");`

`$lab = $container->create_object($properties_array);`

`$container->set_app("breeds");`

`$dog_app = $container->get_dog_application("breeds");`

`$method_array = get_class_methods($lab);`

`$last_position = count($method_array) - 1;`

`$container = NULL;`

`$result = $lab->$method_name($dog_app);`

`$container = NULL;`

`// read dog_data array`

`$container = new dog_container("dog");`

`$properties = "dog";`

`$lab = $container->create_object($properties);`

`$container->set_app("dog");`

`$dog_app = $container->get_dog_application("dog");`

`$method_array = get_class_methods($lab);`

`$last_position = count($method_array) - 1;`

`$method_name = $method_array[$last_position];`

`// return dogs from data`

`$returned_array = $lab->$method_name("ALL");`

`// format dogs list box`

`$resultstring = "<select name='dogs' id='dogs'>";`

`$resultstring = $resultstring . "<option value='-1' selected>NEW</option>";`

`foreach ($returned_array as $column => $column_value)`

`{`

`$resultstring = $resultstring . "<option value='$column'>" . $column_value['dog_name'] . "``&``nbsp;``&``nbsp;``&`T6】

`$resultstring = $resultstring .  $column_value['dog_breed'] . "</option>";`

`}`

`$resultstring = $resultstring . "</select>";`

`print $result . "|" . $resultstring . "|" . '{ "dogs" : ' . json_encode($returned_array) . "}";`

`}`

`}`

`catch(setException $e)`

`{`

`echo $e->errorMessage(); // displays to the user`

`$date = date('m.d.Y h:i:s');`

`$errormessage = $e->errorMessage();`

`$eMessage =  $date . " | User Error | " . $errormessage . "\n";`

`error_log($eMessage,3,USER_ERROR_LOG); // writes message to user error log file`

`}`

`catch(Exception $e)`

`{`

`echo "The system is currently unavailable. Please try again later."; // displays message to the user`

`$date = date('m.d.Y h:i:s');`

`$eMessage =  $date . " | System Error | " . $e->getMessage() . " | " . $e->getFile() . " | ". $e->getLine() . "\n";`

`error_log($eMessage,3,ERROR_LOG); // writes message to error log file`

`error_log("Date/Time: $date - Serious System Problems with Dog Application. Check error log for details", 1, "noone@helpme.com", "Subject: Dog Application Error \nFrom: System Log <systemlog@helpme.com>" . "\r\n");`

`// e-mails personnel to alert them of a system problem`

`}`

`?>`

### 做它

Download the code for this section from the book’s web site. The example code (Example [6-3](6.html#FPar7)) could be broken into several methods to handle the creation of the list boxes and the `dogs` array. Create methods and move the code in these methods to process this information. Call the methods from the previous location of the code.   Download the code for this section from the book’s web site. Adjust the code to handle dog information that will include the following additional fields: `dog_ID` (unique for each dog) and `dog_gender`. Assume that the `dog.php` and `dog_data.php` files will return these fields. You won’t be able to completely test this assignment until you read about the changes to these programs. Note: If you did not previously complete the earlier Do It, complete that assignment along with this one.  

## 在业务规则层中更新、删除和插入

您即将完成 ABC 犬类收容所预订系统。需要对`Dog`类进行一些更改，以确定该类被调用的原因(`insert`、`delete`或`update`)。然后信息可以传递给`dog_data`类中的正确方法。如上所述，不需要对`dog_data`类做任何修改，因为`insert`、`update`和`delete`的方法已经存在。此外，`dog`类必须从`dog_data`中检索所有的狗记录并发送给`dog_interface`。

`<?php`

`class Dog`

`{`

`// ----------------------------------------- Properties ------------------------------------`

`private $dog_weight = 0;`

`private $dog_breed = "no breed";`

`private $dog_color = "no color";`

`private $dog_name = "no name";`

`private $error_message = "??";`

`private $breedxml = "";`

`private $insert = FALSE;`

`private $index = -1;`

在`Dog`类属性的顶部，`$insert`和`$index`被创建来保存由`dog_interface`程序从`properties_array`传递的值。`$index`初始设置为`-1`，表示默认假设用户选择了新的或者没有从狗列表框中选择狗(在`lab.php`)。

`if((is_bool($properties_array[5])) && ($properties_array[6] > -1))`

`{ // confirms true or false and valid index or takes default`

`$this->insert = $properties_array[5];`

`$this->index = $properties_array[6];`

`}`

`$this->change_dog_data("Insert/Update");`

`}`

`if(is_numeric($properties_array))`

`{   // confirms valid index don't delete if not valid`

`$this->index = $properties_array;`

`$this->change_dog_data("Delete");`

`}`

在构造函数中，在验证了狗值(`dog_name`、`dog_breed`、`dog_weight`和`dog_color`)之后，还需要验证插入和索引值。所示的`if`语句使用 PHP 方法`is_bool`来确定`$properties_array[5]`中的值是`TRUE`还是`FALSE. $properties_array[5]`是来自`insert`属性的值的位置。(如果是插页，则设置为`TRUE`，如果是`Update`，则设置为`FALSE`)。`if`语句还确定`$properties_array[6]`中的值是否大于`-1`。大于`-1`的值表示更新或删除。值`-1`表示插入请求。如果有效，这些值被放入`$this->insert`和`$this->index`。然后名为`change_dog_data`的`private`方法被称为传入“插入/更新”。

下一个`if`语句使用 PHP 方法`is_numeric`来确定`$properties_array`实际上是否不是一个数组，以及它是否包含一个数字。如果这是真的，那么要删除的狗的索引已经通过。如果是这种情况，那么将`$property_array`(包含要删除的索引)放在`$this->index`中，调用`change_dog_data`的`private`方法在“delete”中被调用。

`private function change_dog_data($type)`

`{`

`if ( file_exists("e8dog_container.php")) {`

`require_once("e8dog_container.php"); // use chapter`[`5`](5.html)T2】

`} else         {`

`throw new Exception("Dog container file missing or corrupt");`

`}`

`$container = new dog_container("dogdata"); // sets the tag name to look for in XML file`

`$properties_array = array("dogdata"); // not used but must be passed into create_object`

`$dog_data = $container->create_object($properties_array); // creates dog_data object`

新的`change_dog_data`方法(在前面的代码中调用)将使用与前面章节中显示的`display_dog_data`方法非常相似的代码。首先，该方法验证`dog_container`是否存在。如果容器存在，则创建一个容器实例(`$container`)，传递`"dogdata"`，告诉容器这个请求将使用 dogs XML 文件。下一个`$properties_array`是用一个包含`"dogdata"`的简单数组创建的。这个数组实际上不会被使用。然而，`dog_data`类要求将某些东西传递到构造函数中。现在使用容器的`create_object`方法创建了`dog_data` ( `$dog_data`)的一个实例。

`$method_array = get_class_methods($dog_data);`

`$last_position = count($method_array) - 1;`

`$method_name = $method_array[$last_position];`

如前面的代码所示，`change_dog_data`方法使用 PHP `get_class_methods`创建一个包含在`dog_data`对象(`$dog_data)`中的方法数组。`dog_data`中的最后一个方法是`processRecords`方法，它使用一个`case`语句来调用正确的私有方法。

`if (($this->index > -1) && ($type == "Delete"))`

`{`

`$record_Array = $this->index;`

`$dog_data->$method_name("Delete",$record_Array);`

`}`

如果索引大于`-1`，类型为`"delete"`，那么`change_dog_data`方法调用`dog_data`对象的`processRecords`方法，并传递`"delete"`和要删除的索引。

`else if (($this->index == -1) && ($type == "Insert/Update"))`

`{`

`$record_Array = array(array('dog_name'=>"$this->dog_name", 'dog_weight'=>"$this->dog_weight", 'dog_color'=>"$this->dog_color", 'dog_breed'=>"$this->dog_breed"));`

`$dog_data->$method_name("Insert",$record_Array);`

`}`

如果索引是`-1`并且类型是`"insert/update"`，那么用户已经请求“插入”。创建一个包含所有狗属性的数组(`dog_name, dog_weight, dog_color`和`dog_breed`)。然后“插入”和数组被传递到`dog_object`的`processRecords`方法中。

`else if ($type == "Insert/Update")`

`{`

`$record_Array = array($this->index => array('dog_name'=>"$this->dog_name", 'dog_weight'=>"$this->dog_weight", 'dog_color'=>"$this->dog_color", 'dog_breed'=>"$this->dog_breed"));`

`$dog_data->$method_name("Update",$record_Array);`

`}`

`$dog_data = NULL;`

`}`

如果索引不是`-1`并且类型是`"insert/update"`，则用户已经请求更新信息。创建了带有`insert`的相同数组，但有一个例外。数组的索引(`array($this->index =>`)被设置为要更新的记录的索引。然后，该数组和“更新”被传递给`dog_data`对象的`processRecords`方法。

在记录被插入、更新或删除后，`dog_data`对象(`$dog_data`)被设置为`NULL`。如前几章所述，`dog_data`对象首先更新 associate 数组，该数组包含每只狗的信息。当调用`dog_data`对象的析构函数时，信息被更新到`dog_data` XML 文件中。将`$dog_data`设置为`NULL`释放`dog_data`对象，该对象调用其析构函数。

这就完成了对业务规则层的所有更改。让我们把它们放在一起。

Example 8-4\. The dog.php file with update, insert, and delete

`<?php`

`class Dog`

`{`

`// ----------------------------------------- Properties ------------------------------------`

`private $dog_weight = 0;`

`private $dog_breed = "no breed";`

`private $dog_color = "no color";`

`private $dog_name = "no name";`

`private $error_message = "??";`

`private $breedxml = "";`

`private $insert = FALSE;`

`private $index = -1;`

`// ---------------------------------- Constructor ------------------------------------------`

`function __construct($properties_array)`

`{`

`if (method_exists('dog_container', 'create_object')) {`

`if (is_array($properties_array)) {`

`$this->breedxml = $properties_array[4];`

`$name_error = $this->set_dog_name($properties_array[0]) == TRUE ? 'TRUE,' : 'FALSE,';`

`$color_error = $this->set_dog_color($properties_array[2]) == TRUE ? 'TRUE,' : 'FALSE,';`

`$weight_error= $this->set_dog_weight($properties_array[3]) == TRUE ? 'TRUE' : 'FALSE';`

`$breed_error = $this->set_dog_breed($properties_array[1]) == TRUE ? 'TRUE,' : 'FALSE,';`

`$this->error_message = $name_error . $breed_error . $color_error . $weight_error;`

`if(stristr($this->error_message, 'FALSE'))`

`{`

`throw new setException($this->error_message);`

`}`

`if((is_bool($properties_array[5]))``&&`T2】

`{ // confirms true or false and valid index or takes default`

`$this->insert = $properties_array[5];`

`$this->index = $properties_array[6];`

`}`

`$this->change_dog_data("Insert/Update");`

`}`

`if(is_numeric($properties_array))`

`{   // confirms valid index don't delete if not valid`

`$this->index = $properties_array;`

`$this->change_dog_data("Delete");`

`}`

`}`

`else`

`{`

`exit;`

`}`

`}`

`function clean_input() { }`

`function set_dog_name($value)`

`{`

`$error_message = TRUE;`

`(ctype_alpha($value) && strlen($value) <= 20) ? $this->dog_name = $value : $this->error_message = FALSE;`

`return $this->error_message;`

`}`

`function set_dog_weight($value)`

`{`

`$error_message = TRUE;`

`(ctype_digit($value) && ($value > 0 && $value <= 120)) ? $this->dog_weight = $value : $this->error_message = FALSE;`

`return $this->error_message;`

`}`

`function set_dog_breed($value)`

`{`

`$error_message = TRUE;`

`($this->validator_breed($value) === TRUE) ? $this->dog_breed = $value : $this->error_message = FALSE;`

`return $this->error_message;`

`}`

`function set_dog_color($value){`

`$error_message = TRUE;`

`(ctype_alpha($value) && strlen($value) <= 15) ? $this->dog_color = $value : $this->error_message = FALSE;`

`return $this->error_message; }`

`/ -------------------------------- Get Methods ---------------------------------------------`

`function get_dog_name()`

`{`

`return $this->dog_name;`

`}`

`function get_dog_weight()`

`{`

`return $this->dog_weight;`

`}`

`function get_dog_breed()`

`{`

`return $this->dog_breed;`

`}`

`function get_dog_color()`

`{`

`return $this->dog_color;`

`}`

`function get_properties()`

`{`

`return "$this->dog_name,$this->dog_weight,$this->dog_breed,$this->dog_color.";`

`}`

`// ----------------------------General Methods---------------------------------------------`

`private function validator_breed($value)`

`{`

`$breed_file = simplexml:load_file($this->breedxml);`

`$xmlText = $breed_file->asXML();`

`if(stristr($xmlText, $value) === FALSE)`

`{`

`return FALSE;`

`}`

`else`

`{`

`return TRUE;`

`}`

`}`

`private function change_dog_data($type)`

`{`

`if ( file_exists("e8dog_container.php")) {`

`require_once("e8dog_container.php"); // use chapter`[`5`](5.html)T2】

`} else {`

`throw new Exception("Dog container file missing or corrupt");`

`}`

`$container = new dog_container("dogdata"); // sets the tag name to look for in XML file`

`$properties_array = array("dogdata"); // not used but must be passed into create_object`

`$dog_data = $container->create_object($properties_array); // creates dog_data object`

`$method_array = get_class_methods($dog_data);`

`$last_position = count($method_array) - 1;`

`$method_name = $method_array[$last_position];`

`if (($this->index > -1)``&&`T2】

`{`

`$record_Array = $this->index;`

`$dog_data->$method_name("Delete",$record_Array);`

`}`

`else if (($this->index == -1)``&&`T2】

`{`

`$record_Array = array(array('dog_name'=>"$this->dog_name", 'dog_weight'=>"$this->dog_weight", 'dog_color'=>"$this->dog_color", 'dog_breed'=>"$this->dog_breed"));`

`$dog_data->$method_name("Insert",$record_Array);`

`}`

`else if ($type == "Insert/Update")`

`{`

`$record_Array = array($this->index => array('dog_name'=>"$this->dog_name", 'dog_weight'=>"$this->dog_weight", 'dog_color'=>"$this->dog_color", 'dog_breed'=>"$this->dog_breed"));`

`$dog_data->$method_name("Update",$record_Array);`

`}`

`$dog_data = NULL;`

`}`

`function display_dog_data($record)`

`{`

`if ( file_exists("e8dog_container.php")) {`

`require_once("e8dog_container.php"); // use chapter`[`5`](5.html)T2】

`} else {`

`throw new Exception("Dog container file missing or corrupt");`

`}`

`$container = new dog_container("dogdata"); // sets the tag name to look for in XML file`

`$properties_array = array("dogdata"); // not used but must be passed into create_object`

`$dog_data = $container->create_object($properties_array); // creates dog_data object`

`$method_array = get_class_methods($dog_data);`

`$last_position = count($method_array) - 1;`

`$method_name = $method_array[$last_position];`

`$record_Array = $record;`

`return $dog_data->$method_name("Display",$record_Array);`

`}`

`}`

`?>`

正如您所看到的，不需要对`dog_data.php`文件进行修改，因为它已经包含了插入、更新和删除方法。

### 做它

Download the code for this section from the book’s web site. Run the (almost) completed program. Try to “break” the program. Did you accomplish the task? If so, what broke? Attempt to fix any problems you might discover.   Download the code for this section from the book’s web site. Adjust the code to handle dog information that will include the following additional fields: `dog_ID` (unique for each dog) and `dog_gender`. Adjust the `dog.php` and `dog_data.php` programs to return these fields. You should now be able to test the complete application. Note: If you did not previously complete the Do Its earlier in this chapter, complete these assignments along with this one.  

## 最后润色

您将在本节中完成 ABC 犬类收容所预订系统的编码(最后！).你将使用第二章中的一些 CSS 代码来帮助应用程序看起来更专业。此外，您将添加一个菜单，允许用户阅读错误日志并退出应用程序(关闭会话)。

《T2》第二章中的 CSS 代码使用 HTML 标签(`<div id='wrapper'>`)来控制`body`部分的内容。因此，该标记直接添加在 body 标记之后(并且正好在结束 body 标记之前结束)。

`<body onload="checkJS();">`

`<div id="wrapper">`

`<div id="header"><h1><img src="brody.jpg"> ABC Canine Shelter Reservation System</h1>`

CSS 代码还使用 HTML 标签(`<div id='header'>`)来格式化页面的标题。代码也进行了调整，使用 HTML `img`标签添加了一张狗的图片。

`<a href="e8readerrorlog.php">Manage Error Logs</a> | <a href="e75changepassword.php">Change Password</a> | <a href="e8lab.php?logoff=True">Log Off</a>`

`</div>`

在`header`部分还包括一个简单的菜单，允许用户读取错误日志、更改密码或注销应用程序。注意，注销系统的代码将调用`lab.php`程序，并创建一个值为`"True"`的属性`"logoff"`。您将对`lab.php`代码做最后的调整来处理这个选择。

body 部分的所有剩余内容都放在 HTML 标记(`<div ='contents'>`)中。

`<head>`

`<title>ABC Canine Shelter Reservation System</title>`

`<link href="e8dogstylesheet.css" rel="stylesheet">`

第二章中的 CSS 代码将被拉入到`head`部分的文件中。该文件已被重命名。该文件的内容保持不变，只是在包装器中添加了一个`float: top`来将显示与浏览器顶部对齐，并在标题中添加了一个`text-align: center`来将应用程序的标题居中。

这些变化为应用程序提供了更好的外观。

在`lab.php`程序中，你需要查看的最后一个代码是`logoff`例程。

`session_start();`

`if (isset($_GET['logoff']))`

`{`

`session_destroy();`

`}`

`if ((!isset($_SESSION['username'])) || (!isset($_SESSION['password'])) || (isset($_GET['logoff']))) {`

在`lab.php`代码的顶部，添加了一个`if`语句，以确定`logoff`是否已被置位(通过`GET`)。如果有，会话将被销毁。用于确定用户 ID 和密码是否尚未设置的`if`语句，也被修改为包括检查`logoff`是否已设置。如果已经设置，则(此时)用户不再登录系统。

`echo "<html><head><title>ABC Canine Shelter Reservation System</title>";`

`echo "<link href= 'e8dogstylesheet.css' rel='stylesheet'><style type='text/css'>img { height: 100px; width: 140px; }</style></head><body>";`

`echo "<div id='wrapper'><div id='header'><h1><img src='brody.jpg'>ABC Canine Shelter Reservation System</h1></div>";`

`echo "<div id='content'>";`

`echo "You must login to access the ABC Canine Shelter Reservation System";`

`echo "<p>";`

`echo "<a href='e74login.php'>Login</a> | <a href='e73registration.php'>Create an account</a>";`

`echo "</p>";`

`echo "</div><div id='footer'>Copyright © 2015 Little Ocean Waves Publishing - Steve Prettyman</div></div>";`

`echo "</body></html>";`

然后，用户被重定向到登录或创建帐户。还要注意，代码已经被修改，为`wrapper`、`header`、`content`和`footer`添加了相同的`div`标签。这将赋予页面与`lab.php`文件相同的外观。

此外，向用户显示的任何页面都应该具有这种外观。`readerrorlog`程序的`displayRecords`方法也被修改(如此处所示)以包含相同的`div`标签。

`echo "<html><head><title>ABC Canine Shelter Reservation System</title>";`

`echo "<link href=' e8dogstylesheet.css' rel='stylesheet'>";`

`echo "<style> table { border: 2px solid #5c744d;}";`

`echo "img { height: 100px; width: 140px; } </style>";`

`echo "</head><body>";`

`echo "<div id='wrapper'><div id='header'><h1><img src='brody.jpg'> ABC Canine Shelter Reservation System</h1></div><div id='content'>";`

`echo "<table>";`

`echo "<caption>Log File: " . ERROR_LOG . "</caption>";`

`echo "<tr><th></th><th>Date/Time</th><th>Error Type</th><th>Error Message</th></tr><tr>";`

`for ($J=$row_Count; $J >= 0; $J--)`

`{`

`echo "<td><a href='e58readlogfile.php?rn=$J'>Delete</a></td>";`

`for($I=0; $I < 3; $I++)`

`{`

`echo "<td> " . $error_Array[$J][$I] . " </td> ";`

`}`

`echo "</tr>";`

`}`

`echo "</table>";`

`echo "</div><div id='footer'>Copyright © 2015 Little Ocean Waves Publishing - Steve Prettyman</div></div>";`

`echo "</body></html>";`

让我们看看例子 [8-5](#FPar7) 中`lab.php`的最终版本。

Example 8-5\. The complete lab.php file

`<?php`

`session_start();`

`if (isset($_GET['logoff']))`

`{`

`session_destroy();`

`}`

`if ((!isset($_SESSION['username'])) || (!isset($_SESSION['password'])) || (isset($_GET['logoff']))) {`

`echo "<html><head><title>ABC Canine Shelter Reservation System</title>";`

`echo "<link href='e8dogstylesheet.css' rel='stylesheet'><style type='text/css'>img { height: 100px; width: 140px; }</style></head><body>";`

`echo "<div id='wrapper'><div id='header'><h1><img src='brody.jpg'>ABC Canine Shelter Reservation System</h1></div>";`

`echo "<div id='content'>";`

`echo "You must login to access the ABC Canine Shelter Reservation System";`

`echo "<p>";`

`echo "<a href='e74login.php'>Login</a> | <a href='e73registration.php'>Create an account</a>";`

`echo "</p>";`

`echo "</div><div id='footer'>Copyright``&`T2】

`echo "</body></html>";`

`}`

`else if(($_SERVER['HTTP_REFERER'] == '`[`http://127.0.0.1:8080/mysite/bgchapter8/ExampleFile7.4/e74login.php`](http://127.0.0.1:8080/mysite/bgchapter8/ExampleFile7.4/e74login.php)`') || ($_SERVER['HTTP_REFERER'] == '`[`http://127.0.0.1:8080/mysite/bgchapter8/ExampleFile7.4/e8lab.php`](http://127.0.0.1:8080/mysite/bgchapter8/ExampleFile7.4/e8lab.php)T4】

`{`

`?>`

`<!DOCTYPE html>`

`<html lan="en">`

`<head>`

`<title>ABC Canine Shelter Reservation System</title>`

`<link href=" e8dogstylesheet.css" rel="stylesheet">`

`<script src="e8getlists.js"></script>`

`<script src="e5validator.js"></script>`

`<style type="text/css">`

`#JS { display:none; }`

`#input_form { display:none; }`

`#insert {display: none; }`

`#delete {display: none; }`

`#update {display: none; }`

`img { height: 100px; width: 140px; }`

`</style>`

`<script>`

`function checkJS() {`

`document.getElementById('JS').style.display = "inline";`

`}`

`function process_select() {`

`var colorbuttons = document.getElementsByName('dog_color');`

`if(!(document.getElementById('dogs').value == -1))`

`{`

`index = document.getElementById('dogs').selectedIndex -1;`

`document.getElementById('index').value = index;`

`document.getElementById('dog_name').value = obj.dogs[index].dog_name;`

`document.getElementById('dog_weight').value = obj.dogs[index].dog_weight;`

`dog_color = obj.dogs[index].dog_color;`

`if(dog_color == "Brown")`

`{`

`colorbuttons[0].checked = true;`

`} else if (dog_color == "Black")`

`{`

`colorbuttons[1].checked = true;`

`} else if (dog_color == "Yellow")`

`{`

`colorbuttons[2].checked = true;`

`}`

`else if (dog_color == "White")`

`{`

`colorbuttons[3].checked = true;`

`}`

`dog_breed = obj.dogs[index].dog_breed;`

`document.getElementById('dog_breed').value = dog_breed;`

`document.getElementById('update').style.display = "inline";`

`document.getElementById('delete').style.display = "inline";`

`document.getElementById('insert').style.display = "none";`

`}`

`else`

`{`

`colorbuttons[4].checked = true;`

`document.getElementById('dog_name').value = "";`

`document.getElementById('dog_weight').value = "";`

`document.getElementById('dog_breed').value = "Select a dog breed";`

`document.getElementById('insert').style.display = "inline";`

`document.getElementById('update').style.display = "none";`

`document.getElementById('delete').style.display = "none";`

`}`

`document.getElementById('input_form').style.display = "inline";`

`}`

`</script>`

`</head>`

`<body onload="checkJS();">`

`<div id="wrapper">`

`<div id="header"><h1><img src="brody.jpg"> ABC Canine Shelter Reservation System</h1>`

`<a href="e8readerrorlog.php">Manage Error Logs</a> | <a href="e75changepassword.php">Change Password</a> | <a href="e8lab.php?logoff=True">Log Off</a>`

`</div>`

`<div id="content">`

`<?php`

`if (isset($_SESSION['message']))`

`{`

`echo "<p>" . $_SESSION['message'] . "</p>";`

`}`

`else`

`{`

`echo "<p> Welcome back, " . $_SESSION['username'] . "</p>";`

`}`

`?>`

`<div id="JS">`

`<script>`

`AjaxRequest('e8dog_interface.php');`

`</script>`

`<h3>Pick the dog name and breed to change from the dropdown box, then click the button.<br>For new dog information select 'NEW'.</h3>`

`Select 'NEW' or Dog's Name/Breed <div id="AjaxReturnValue"></div>`

`<input type="button" name="selected" id="selected" value="Click to select" onclick="process_select()" /><br><br>`

`<div id="input_form">`

`<form method="post" action="e8dog_interface.php" onSubmit="return validate_input(this)">`

`<h3>Please note the required format of information.</h3>`

`<hr>`

`Enter Your Dog's Name (max 20 characters, alphabetic) <input type="text" pattern="[a-zA-Z]*" title="Up to 20 Alphabetic Characters" maxlength="20" name="dog_name" id="dog_name" required/><br /><br />`

`Select Your Dog's Color:<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Brown">Brown<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Black">Black<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Yellow">Yellow<br />`

`<input type="radio" name="dog_color" id="dog_color" value="White">White<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Mixed" checked >Mixed<br /><br />`

`Enter Your Dog's Weight (numeric only) <input type="number" min="1" max="120" name="dog_weight" id="dog_weight" required /><br /><br />`

`<input type="hidden" name="dog_app" id="dog_app" value="dog" />`

`Select Your Dog's Breed <div id="AjaxResponse"></div><br />`

`<input type="hidden" name="index" id="index" value="-1"/>`

`<input type="submit" name="insert" id="insert" value="Click to create your dog info" />`

`<input type="submit" name="delete" id="delete" value="Click to remove your selected dog info" />`

`<input type="submit" name="update" id="update" value="Click to update your selected dog info" />`

`<hr>`

`</form>`

`</div> </div>`

`<noscript>`

`<div id="noJS">`

`<form method="post" action="e8dog_interface.php">`

`<h3>For Updates please enter all fields. For Deletions enter at least the dog name and breed. Then click the button.<br>For new dog information enter the requested information, Then click the button.<br> Please note the required format of information.</h3>`

`Enter Your Dog's Name (max 20 characters, alphabetic) <input type="text" pattern="[a-zA-Z ]*"title="Up to 20 Alphabetic Characters" maxlength="20" name="dog_name" id="dog_name" required/><br /><br />`

`Select Your Dog's Color:<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Brown">Brown<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Black">Black<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Yellow">Yellow<br />`

`<input type="radio" name="dog_color" id="dog_color" value="White">White<br />`

`<input type="radio" name="dog_color" id="dog_color" value="Mixed" checked >Mixed<br /><br />`

`Enter Your Dog's Weight (numeric only) <input type="number" min="1" max="120" name="dog_weight" id="dog_weight" required /><br /><br />`

`Enter Your Dog's Breed (max 35 characters, alphabetic) <input type="text" pattern="[a-zA-Z ]*" title="Up to 15 Alphabetic Characters" maxlength="35" name="dog_breed" id="dog_breed" required /><br />`

`<input type="hidden" name="dog_app" id="dog_app" value="dog" />`

`<input type="submit" name="input" id="input" value="Click to create your dog info" />`

`<input type="submit" name="delete" id="delete" value="Click to remove your selected dog info" />`

`<input type="submit" name="update" id="update" value="Click to update your selected dog info" />`

`</form>`

`</div>`

`</noscript>`

`</div>`

`<div id="footer">Copyright``&`T2】

`</div>`

`</body> </html>`

`<?php   }  ?>`

Example 8-6\. The complete readerrorlog.php file

`<?php`

`session_start();`

`function deleteRecord($recordNumber, &$row_Count, &$error_Array)`

`{`

`for ($J=$recordNumber; $J < $row_Count - 1; $J++)`

`{`

`for($I=0; $I < 3; $I++)`

`{`

`$error_Array[$J][$I] = $error_Array[$J + 1][$I];`

`}`

`}`

`unset($error_Array[$row_Count]);`

`$row_Count--;`

`}`

`function saveChanges($row_Count,$error_Array,$log_File)`

`{`

`$logFile = fopen($log_File, "w");`

`for($I=0; $I < $row_Count; $I++)`

`{`

`$writeString = $error_Array[$I][0] . " | " . $error_Array[$I][1] . " | " . $error_Array[$I][2];`

`fwrite($logFile, $writeString);`

`}`

`fclose($logFile);`

`}`

`function displayRecords($row_Count, $error_Array)`

`{`

`echo "<html><head><title>ABC Canine Shelter Reservation System</title>";`

`echo "<link href= 'e8dogstylesheet.css' rel='stylesheet'>";`

`echo "<style> table { border: 2px solid #5c744d;}";`

`echo "img { height: 100px; width: 140px; } </style>";`

`echo "</head><body>";`

`echo "<div id='wrapper'><div id='header'><h1><img src='brody.jpg'> ABC Canine Shelter Reservation System</h1></div><div id='content'>";`

`echo "<table>";`

`echo "<caption>Log File: " . ERROR_LOG . "</caption>";`

`echo "<tr><th></th><th>Date/Time</th><th>Error Type</th><th>Error Message</th></tr><tr>";`

`echo "<tr><th></th><th>Date/Time</th><th>Error Type</th><th>Error Message</th></tr><tr>";`

`for ($J=$row_Count; $J >= 0; $J--)`

`{`

`echo "<td><a href='e58readlogfile.php?rn=$J'>Delete</a></td>";`

`for($I=0; $I < 3; $I++)`

`{`

`echo "<td> " . $error_Array[$J][$I] . " </td> ";`

`}`

`echo "</tr>";`

`}`

`echo "</table>";`

`echo "</div><div id='footer'>Copyright``&`T2】

`echo "</body></html>";`

`}`

`const ERROR_LOG = "Errors.log";`

`if ((!isset($_SESSION['username'])) || (!isset($_SESSION['password']))) {`

`echo "<html><head><title>ABC Canine Shelter Reservation System</title>";`

`echo "<link href='e8dogstylesheet.css' rel='stylesheet'><style type='text/css'>img { height: 100px; width: 140px; }</style></head><body>";`

`echo "<div id='wrapper'><div id='header'><h1><img src='brody.jpg'>ABC Canine Shelter Reservation System</h1></div>";`

`echo "<div id='content'>";`

`echo "You must login to access the ABC Canine Shelter Reservation System";`

`echo "<p>";`

`echo "<a href='e74login.php'>Login</a> | <a href='e73registration.php'>Create an account</a>";`

`echo "</p>";`

`echo "</div><div id='footer'>Copyright``&`T2】

`echo "</body></html>";`

`}`

`else`

`{`

`$logFile = fopen(ERROR_LOG, "r");`

`$row_Count = 0;`

`while(!feof($logFile))`

`{`

`$error_Array[$row_Count] = explode(' | ', fgets($logFile));`

`$row_Count++;`

`}`

`$row_Count--;`

`fclose($logFile);`

`if(isset($_GET['rn']))`

`{`

`deleteRecord($_GET['rn'], $row_Count, $error_Array);`

`saveChanges($row_Count,$error_Array,ERROR_LOG);`

`}`

`displayRecords($row_Count,$error_Array);`

`}`

`?>`

### 做它

Download the code for this section from the book’s site. Also, download the `displaychangelog.php` program from [Chapter 6](6.html) (in Example [6-4](6.html#FPar9)) along with a change log if you don’t already have one. Update the menu provided in the `lab.php` program to provide a link to the `displaychangelog.php` program. Add code to the `displaychangelog.php` program to require the users to log in. Redirect the users to the choice of login or registration (as shown in the examples) if they are not logged in. Also update the HTML in the `displaychangelog.php` file to use the `e8dogstylesheet.css` file to display the change log page and the login/registration selection page in the same format as shown in Figure [8-5](#Fig5).

![A978-1-4842-1730-6_8_Fig5_HTML.jpg](A978-1-4842-1730-6_8_Fig5_HTML.jpg)

图 8-5。

The complete lab.php file   Download the code for this section from the book’s web site. Adjust the code to handle dog information that will include the following additional fields: `dog_ID` (unique for each dog) and `dog_gender`. Adjust all programs necessary (including the `readerrorlog` and `displaychangelog` (in [6-4](6.html#FPar9))). You should now be able to test the complete application.   Download the code for this section from the book’s site. Add a menu for the users to return to the shelter registration page (`lab.php`) or log off when they are using the `readerrorlog.php` file. Add the code needed to the `readerrorlog.php` file to log off the user. If you have not already done so, include changes need to format the display of the `readerrorlog.php` file as shown in Figure [8-5](#Fig5). Also these changes in the `displaychangelog.php` file (if you did #1).  

## ABC 犬类收容所预定系统逻辑设计

ABC 犬类收容所预订系统的最终逻辑设计展示了具有四层(身份验证、接口、业务规则和数据)的应用程序。额外的层也可以用于在多个服务器上拆分大型应用程序。

![A978-1-4842-1730-6_8_Fig6_HTML.jpg](A978-1-4842-1730-6_8_Fig6_HTML.jpg)

图 8-6。

The complete ABC Canine Shelter Reservation System

除了层级之外，维护程序(`readerrorlog`和`readchangelog`)提供了加强安全性、修复错误以及提供备份和恢复的能力。

### 限制

ABC 犬类收容所预订系统在本书中被用作教学工具。然而，该系统并不完整，并为现实世界做好准备。该系统的许多限制已经在本书中解决了，并作为练习让你获得进一步的 PHP 编程技能。应该对系统进行如下所示的更改，以改善用户体验、安全性和性能。此外，用户测试对于确保系统用户满意至关重要。对系统的设计和性能不满意的用户不太可能使用它。

`lab.php`

*   需要包含一个`Dog_ID`或一些其他类型的独特字段来确定具有相同名称和品种的狗之间的差异。
*   不使用 JavaScript 的用户需要使用 PHP 来调用和检索更新和删除功能所需的信息。
*   需要在菜单选项中提供到`displaychangelog.php`的链接。
*   需要有一个`Dog_Gender`字段。如果有狗狗图片也不错。
*   该程序需要处理和响应用户试图插入一只已经存在的狗。

`dog_interface.php`

*   `Dog_ID`信息(更新/插入)需要从`Dog`类接受并传递给`lab.php`。
*   需要代码将请求返回给`lab.php`以获得完整的 dogs 数组，并为支持`non_JavaScript`的浏览器返回特定的 dogs。该信息将从`dog.php`检索。
*   需要从`dog.php`中取出`Dog_Gender`字段，并将其传递给`lab.php`。
*   当用户试图输入一只已经在数据中的狗时，必须向`lab.php`程序传递一条会话消息。该消息在`catch`块中创建。

`dog.php`

*   `Dog_ID`信息需要从`dog_data.php`中提取并传递给`dog_interface.php`。
*   `Dog_Gender`需要从`dog_data.php`中取出并传递给`dog_interface.php`。

`dog_data.php`

*   需要将`Dog_ID`传递给`dog.php`。需要包括插入和更新该字段的能力。
*   需要将`Dog_Gender`传递给`dog.php`。插入和更新该字段的能力需要包括在内。

`register.php`

*   该程序需要包括一个唯一的字段(`customerID`)来确定重复的用户 id。该字段将由用户生成而非输入。
*   这个程序需要检测用户试图创建一个重复的 ID。代码甚至可以根据用户试图创建的内容为用户 ID 名称提供建议(比如在用户 ID 的末尾添加数字)。
*   这个程序需要要求用户也使用一个特殊的密码符号。
*   这个程序需要安全问题，以防用户忘记密码。
*   还需要其他字段，如姓名、电子邮件和地址。

`login.php`

*   这个程序需要能够为忘记密码但记得安全问题答案的用户创建一个临时密码。

全部的

*   您需要考虑将更多的程序(文件)名转移到 XML 文件中，以便更容易地进行版本更改。
*   您需要考虑增加新用户 id 的访问和批准级别。

## 章节术语

<colgroup><col> <col></colgroup> 
| $ _ server[' http _ reference '] | HTML 按钮 |
| 使分离 | 定义变量 |
| 对象 | JSON 语法分析 |
| getElementsByName | HTML 列表框 |
| 项时 | 价值 |
| 点符号格式 | 已检查的属性 |
| is_bool | 图片 |
| 浮动:顶部 | 文本对齐:居中 |
| 四层应用程序 |   |

### 第二章问题和项目

多重选择

Which JavaScript method accomplishes a similar task as the PHP method `explode`? `explode`   `slice`   `split`   None of these     Which JavaScript method accomplishes a similar task as the PHP method `json_decode`? `JSON.scan`   `JSON.parse`   `JSON.decode`   None of these     A JSON object is similar to which PHP object? An array   A multidimensional array   An associative array   None of these     An HTML button can be used to do what? Can be used to call a JavaScript method   Can submit a form   Can display a form   All of the above     The `private` word is used to create a private object in PHP. What word is used in JavaScript to accomplish the same? `private`   No additional word is needed; they are private by default   `var`   None of these    

对/错

JavaScript is commonly used to retrieve and use data passed from other program languages.   The CSS code `display:` form is used to display a form that has been hidden from the user.   The CSS code `p {float: top }` will cause everything in all paragraph tags to float to the top of the browser window.   `getElementsByName` can be used to create an array from a grouping of radio buttons.   `is_numeric` could be used to determine if an object is not an array.  

简答/短文

Explain why and how initially hiding a form from the users will force them to make a selection from a list box.   Explain how each program in the ABC Canine Shelter Reservation System uses -1 to indicate a request for insert.   Explain each tier of a four-tier application.   What changes would need to occur in the ABC Canine Shelter Reservation System to convert it to a Feline Shelter Reservation System?   Give an example of three algorithms (blocks of code) that have been continuously reused in the ABC Canine Shelter Reservation System.  

项目

Go back to the section entitled “Limitations” in this chapter and view the list again. Download the complete code from this chapter and fix one (or more) of these limitations. Make sure to fix the limitation in all the applicable files.  

学期项目

Update the ABC Computer Parts Inventory application to provide complete `delete`, `update`, and `insert` capabilities (as shown in this chapter). Add CSS to each program in the application interface to provide a more professional display of the information. Add any code needed to ensure that the users are logged in to access any part of the application. List any limitations that still exist in this application.