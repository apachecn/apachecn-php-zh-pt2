# 2.什么是云

对于什么是“在云中”有一点混淆。一些人甚至错误地认为仅仅是在互联网上就是在利用云技术。

云技术和其他类型的互联网托管的本质区别在于，云服务至少提供了快速扩展应用程序的能力。过去，开发人员会将他们的 web 应用程序部署到他们在特定场所购买或租赁的固定服务器上。获得更多的设备是可能的，但这总是要花费相当多的时间和精力。通常，开发人员必须为服务器投入大量资金，购买、配置和部署服务器。这个过程可能需要几周甚至几个月。即使直接从托管公司购买，汇总报价和启动运行的过程也可能需要一周以上。

云的承诺是，不必经历新服务器的物理设置过程，可以即时或至少在几分钟或几小时内获得额外的容量，而不是几天、几周或几个月。对于某些解决方案，您甚至不必担心机器—云解决方案会根据您的需要自动将您的应用程序扩展到任意多的机器上。对于其他人来说，只需点击几下鼠标就可以请求、映像和启动一台新机器，这台机器是某台现有机器的副本，然后将它添加到您的 web 应用程序中。

无论如何，云的核心思想是即时、自动化的可伸缩性和灵活性。

许多云提供商甚至提供对多个数据中心的访问。是要一套美国的服务器，一套欧洲的服务器？没问题。只需点击几下，就能搞定。

## 2.1 基础设施即服务

云计算经常令人困惑，因为云计算有几种不同的*类型*，每种类型都有自己的优点和缺点。云服务类型之间的差异主要基于所提供的抽象级别。

本书将重点介绍的最基本类型的云服务被称为基础设施即服务，缩写为 IaaS。IaaS 意味着您可以购买和部署基础设施(服务器、负载平衡器、防火墙等)。)只需点击一下按钮。这是通过服务器虚拟化技术实现的。

服务器虚拟化允许 IaaS 服务公司部署单个非常大的服务器，并将其拆分为多个较小的服务器。每台服务器运行一个*虚拟机管理程序*程序，该程序允许公司快速自动地拆分服务器。一家公司可能会将一台拥有 16 个处理器和 64g RAM 的计算机分成 4 个虚拟机，每个虚拟机拥有 4 个处理器和 16g RAM。

这样做有三个好处。首先是空间。通过购买最大的机器，IaaS 公司为自己提供了每机架单元最大的计算能力，这在服务器机房中是一种有价值的商品。因此，通过购买一台大型机器并将其分成四台较小的机器，他们只使用了原本可以使用的空间的四分之一。

第二是每个 CPU 内核的成本。通过将如此多的 CPU 核心和如此多的内存打包到一台服务器中，它们的每 CPU 核心成本和每千兆字节内存成本都会下降。因此，通过购买更大的计算机，他们可以为购买较小的虚拟服务器的用户提供更低的每 CPU 核心成本。

然而，第三个优势也是最重要的—可管理性。为了支持虚拟化，每台机器的一小部分专用于管理程序，即管理服务器上其他虚拟机的小操作系统。因为这些机器是虚拟机，而不是真正的硬件设备，所以非常容易管理。操作员可以向管理程序发送命令，管理程序可以立即设置新的虚拟机，克隆新的引导磁盘，并在几分钟内启动新的虚拟服务器。

从历史上看，如果我想要一台新的服务器，我必须购买服务器，然后在控制台前安装相关的操作系统和系统软件，最后将服务器搬到机架上，插上电源并打开。我必须确保网络接通并配置好。我可能需要配置 BIOS 来允许键盘断开连接的操作。如果机器出了问题，我要做机器的备份，找一个新的物理机，把备份复制到新机器上，装上新机器，和旧机器物理换出来。

有了虚拟机，我可以让虚拟机管理程序处理所有这些事情。我所需要的只是运行虚拟机管理程序的足够多的额外服务器，这样当我需要一台新机器时，我就可以告诉虚拟机管理程序为我创建一台新的虚拟机，以及我想要使用的磁盘副本的位置。

更好的是，对于大多数 IaaS 平台，您甚至不需要担心虚拟机管理程序和容量。IaaS 供应商会为您完成所有这些工作。IaaS 供应商提供了一个点击式界面，允许您只需登录到 web 管理控制台就可以启动虚拟服务器。你告诉它你想要多大的机器(即 CPU 核心的数量和内存的大小)，它就会为你分配一台服务器。你告诉它你想在上面安装什么(要么是一个基本操作系统，要么是一个现有机器的克隆)，它就会把它复制到引导盘上，然后帮你启动。瞧啊。您已经有了一台新的服务器。

此外，对于大多数 IaaS 服务，如果存在物理硬件问题，该服务会为您解决。如果检测到严重的硬件问题，他们会简单地关闭您的服务器，将其迁移到新的服务器，重新启动，并向您发送电子邮件，让您知道发生了什么。如果问题不太严重，一些供应商会通知您，要求您在最方便的时候按下按钮执行迁移。

更好的是定价模式。大多数 IaaS 供应商都可以选择*小时*定价。你需要一台机器，但只是几个小时？有了 Linode，你可以以每小时不到 1.00 美元的价格获得一台 32 核 64g 的机器！

在第 [3](03.html) 章中，我们将看看建立云服务器所需的具体步骤。

## 2.2 平台即服务

扩展应用程序的另一个选项称为*平台即服务*，缩写为 PaaS。借助 PaaS，PaaS *定义了*一个让你运行应用程序的平台，而不是给你裸机，让你随心所欲地运行。PaaS 供应商管理整个平台，您只需担心您的应用程序。

例如，Heroku 是一个流行的 PaaS 供应商。Heroku 处理所有的服务器管理和维护。你甚至不能登录他们的机器！您只需将代码推给他们，他们就会为您将代码部署到他们的机器上。其他常见的 PaaS 供应商包括 Google App Engine、Windows Azure、亚马逊的 Elastic Beanstalk 和 OpenShift。

使用 PaaS，您可以选择使用多少“工作人员”，系统将根据需要在多少台机器上分配工作(工作人员只是一个活动的流程，每个 PaaS 供应商都有自己的术语)。因此，PaaS 供应商负责*平台*(硬件、操作系统、安装的应用程序)，您只需管理应用程序代码。

这在理论上听起来很棒——您再也不用管理服务器了！这一切都是在幕后为你自动完成的。然而，现实是，PaaS 平台并不像它们看起来那样透明，PaaS 供应商往往将它们的附加值定得相当高。

## 2.3 码头工人

Docker 是该领域一项新技术，引起了很多关注。Docker 应用介于 IaaS 和 PaaS 之间。Docker 应用程序是一个映像，本质上包含了运行应用程序所需的所有程序的完整安装。

它们可以像 PaaS 一样进行管理、部署和扩展，在 PaaS 中，您只需告诉服务您想要运行多少个，它就会负责将您的映像部署到正确的位置，但您拥有更大程度的控制，类似于 IaaS。

Docker 的一个有趣的部分是将不同的服务“链接”在一起的能力。本质上，您将 Docker 容器提供或需要的不同类型的服务命名，然后可以使用这些名称告诉您的服务如何找到彼此。然而，这通常只是在应用程序的初始设置阶段出现的问题，在此之后，您是手动还是使用高级工具将应用程序组件链接在一起就无关紧要了。

Docker 本身是技术，不是厂商。有许多供应商允许您部署 Docker 应用程序，包括负责 Docker 技术的 Docker Inc .

## 2.4 为什么选择 IaaS

出于多种原因，本书集中讨论 IaaS 云模型。首先是 IaaS 非常灵活。无论您想要运行什么类型的工作负载，无论您想要运行什么平台，IaaS 都会为您提供裸服务器。你如何对待他们取决于你自己。这也意味着您不会被特定供应商的系统所束缚。

第二，IaaS 的工作相当有预见性。虽然存在差异，但大多数 IaaS 供应商的运营方式是相当相似的。你选择一个盒子大小，说你想要什么，然后按下按钮。这些服务的质量、成本和灵活性有很大的差异，但它们都非常相似。

有了 PaaS，您的选择就更加有限了。首先，您受限于您的供应商提供的平台。如果你用 Ruby on Rails 编程，你只能使用 Ruby on Rails PaaS。虽然大多数 PaaS 供应商已经向相当多的不同应用服务器开放了他们的系统，但是仍然存在一些限制。第二，您必须编写与他们配置平台的方式相匹配的代码。这通常涉及很少或没有本地文件存储、要连接的某些特定类型的数据库、仅某些允许的平台选项或扩展，以及在如何配置服务器方面很少或没有灵活性。有时这很好，但有时这太严格了。

此外，PaaS 通常太不透明。访问服务器日志通常很困难，调试特定于服务器的问题几乎是不可能的。有时 PaaS 供应商有工具可以提供帮助，但是它们无法直接在有问题的机器上进行调试。这种不透明有时会导致毁灭性的结果。例如，如果您购买了一个 PaaS 数据库系统，但不知何故您的数据库被破坏了，那么您的选择就非常有限。你基本上要打电话给公司，乞求帮助。有些公司在这方面反应很积极，但这让我很紧张。

还要记住，为了让 PaaS 系统正常工作，他们必须不断升级他们的系统。事实上，这就是你付钱让他们做的事情。然而，不能保证他们明天进行的升级不会意外地破坏您的应用程序。也许升级是必要的，但这不是你能做的决定。

类似地，使用 PaaS 供应商意味着您必须按照他们的时间表升级。如果他们决定放弃他们的基础设施，您必须重写代码来解决这个问题。如果他们认为你使用的软件版本过时了，你必须重写你的代码来使用新版本。简而言之，PaaS 意味着你失去了对你的技术的控制，而 IaaS 意味着你拥有完全的控制权。虽然使用 PaaS 可以消除某些麻烦，但它们通常会被引入的麻烦所弥补。

最后，PaaS 通常非常昂贵。例如，对于 Heroku(一个常见的 Ruby on Rails PaaS 供应商)上的四个 CPU 内核，每月花费 100 美元。对于 Linode 上的 4 核机器，成本仅为每月 40 美元，并且 Linode 机器更快。我发现，对于同等性能，大多数 PaaS 供应商的收费是优秀 IaaS 供应商的三倍左右。PaaS 供应商为您做了更多，但是只有当您的开发人员队伍中没有任何系统管理经验时，这才是值得的，而且无论如何，您都要为跟上 PaaS 平台的步伐而付出代价。

如果您的组织知道如何设置和维护服务器(这本书为学习如何做提供了一个良好的开端)，IaaS 是目前利用云技术最简单、最灵活、最快、最便宜的方式，并且它不会将您局限于特定的供应商。如果您决定真的想要使用类似 PaaS 的系统，只需知道有许多开源的 PaaS 系统可以在您的 IaaS 服务器上运行。

## 2.5 选择 IaaS 供应商

选择 IaaS 服务或供应商时有许多考虑因素。最重要的考虑是服务的可靠性。如果服务中断，即使有一个优秀的 web 应用程序也没有用。如果你不能得到你的数据，从长远来看，它不会为你的公司赚钱。因此，服务的可靠性应该会对您的决策产生重大影响。

这也延伸到他们解决票证的能力。每个服务都会在某个时候出现问题。如果一家公司不能及时响应或解决问题，那么您就不应该让生产系统占用它们。

下一个主要因素是性价比。许多早期的云基础设施公司非常重视云计算的灵活性，结果几乎每个云解决方案的成本都高得惊人。亚马逊网络服务(AWS)的云计算服务 EC2 就是一个很好的例子。如前所述，一台 8GB 内存的 Linode 4 核机每月 40 美元。EC2 上类似指定的机器(`c5.xlarge`机器)是 122 美元/月。从历史上看，即使在相同的规格下，EC2 也往往比 Linode 慢得多。在云计算的早期，EC2 是该领域仅有的大玩家之一，为了获得灵活性，他们让你付出了高昂的代价。就个人而言，按照 EC2 的要价，我更愿意走出云，做一个传统的托管设置，在那里租赁物理服务器。对我来说，这种灵活性不值 AWS 要求的价格。

另一方面，有些云服务的价格高得不可思议。也就是说，你可以从价格上认识到，他们不可能以这样的价格提供可靠的长期服务。要么公司倒闭，要么公司不得不提高价格，要么服务最终会被超额预订，降级到不可用的地步。一个很好的例子就是 CloudAtCost ( [`www.cloudatcost.com`](http://www.cloudatcost.com) )。有了 CloudAtCost，你只需支付一次性费用，就可以永远保留服务器*。例如，花 70 美元，你可以得到 2 个 CPU 内核和 1GB 内存。但是那是每月的费用。那是一笔*一次性的*费用！正如我所说，这是一个令人难以置信的好价格。他们收取每年 9 美元的账户维护费，但不管你有多少台服务器，这个费用都是一样的(这可能是为了让他们可以关闭不再维护的服务器)。*

 *这种服务可能对一些事情有好处。例如，如果您想要一个开发服务器，即使网络偶尔出现故障，或者技术人员不能快速响应，都没有关系。而且，如果有一天他们关了门，你也不会出局太多。但我肯定不会把我的生意押在这样的服务上。如果你想看看其他价格极其便宜的服务，请查看 [`www.lowendbox.com`](http://www.lowendbox.com) 。

最后一个因素是灵活性。能够点击设置一台新机器是一回事，但是如果您不能存储磁盘映像，并且每次启动一台机器时都必须重建一台机器，那该怎么办？这将是一个艰苦的过程，你将失去云计算的一个主要优势。这是 AWS 大放异彩的一个领域。AWS 不仅包括其云计算服务(EC2)，还为云基础设施的几乎每个方面提供配置、控制和自动化。AWS 提供可扩展存储解决方案、视频转码服务、可扩展数据库、消息排队服务和搜索服务。这为您的集群提供了一个外部监控服务，当负载增加时，它会自动生成新的服务器来处理负载，并在网络负载减少时，从您的集群中删除服务器并关闭它们。换句话说，AWS 附带的额外服务几乎是无限的。

然而，到最后，AWS 的灵活性被 EC2 糟糕的性价比压倒了。然而，令人欣慰的是，AWS 更好的服务(如 S3 和 CloudFront)可以单独使用，即使你使用另一个提供商作为你的主要 IaaS 供应商。我们将在后面的章节中讨论如何做到这一点。

如果你还没有猜到，我对云供应商的偏好是 Linode ( [`www.linode.com`](http://www.linode.com) )。他们的性价比是无与伦比的。原因有三。第一，设备较新。其次，他们只使用固态硬盘(即固态硬盘，没有旋转磁盘)，通常比普通磁盘快一个数量级。这可能是 Linode 表现最重要的方面之一。第三，他们实施了控制措施来防止“吵闹的邻居”。

高噪音邻居是与您的机器在同一物理服务器上的虚拟机，但是它使用了计算机的所有 I/O 资源。在 IaaS 平台上，你不能选择(甚至不知道)谁在共享同一个物理硬件。因此，使用防止资源占用的服务非常重要。Linode 实施了许多控制措施来防止任何单个虚拟机过度使用资源。这不仅对你自己的虚拟服务器的性能有好处，而且也意味着你不必担心成为别人的坏邻居！

虽然 Linode 没有 AWS 的灵活性，但这种灵活性也是不容错过的。你想用 AWS 做的大部分重要的事情用 Linode 来做都是极其简单的，AWS 增加的特性让 AWS 的学习曲线变得陡峭而混乱。当有人花费额外的钱来获得 AWS 的灵活性时(例如，创建一个系统来自动引导新机器以响应负载)，他们可能已经在 Linode 上花费了相同的钱来为他们的集群提供足够的容量，这样它就不会有问题了。

还有其他类似于 Linode 的服务——digital ocean 通常被认为是价格相当的类似服务。然而，我和 Linode 的经历非常积极，我觉得没有必要对它们都进行研究。Linode 提供了我需要的东西，有一个易于使用的界面，而且价格非常便宜。因此，本书将重点介绍在 Linode 上开发云应用。

选择供应商时，仔细阅读他们的服务条款也很重要，以确保您的预期用途是兼容的。不仅某些服务不允许某些工作负载(例如，某些服务禁止群发电子邮件营销)，许多服务还限制了允许您扩展网络的速度。这主要是为了防止滥用，但提前发现也很重要。在任何情况下，您都可能希望接触潜在的云供应商，并确保您的计划使用符合他们的服务指南，然后再选择一家。

## 2.6 一些重要术语

在我们进一步讨论之前，我想澄清一下本书中使用的一些术语。借助 IaaS，您租用的基本上都是机器。它们是*虚拟*机器(即真实机器的分区)，但尽管如此，它们本身也可以被认为是抽象的机器。在云计算行话中，它们通常被称为*节点*。由于它们向网络上的其他机器和/或用户提供服务，它们也被认为是*服务器*。因此，节点的另一个常用术语是 VPS，即虚拟专用服务器。在本书中，机器、节点和服务器这三个术语可以互换使用，尽管具体术语的选择通常是基于您目前的使用方式。

一个*集群*是一组协同工作的节点。因此，我们正在云中构建一个集群。在云中可扩展的服务被称为*云集群*，或者简称为*云*。

术语*可扩展性*是云计算中的一个重要术语。可伸缩性不仅仅是性能。性能是指效率或原始速度。可扩展性是指系统快速扩展其处理能力的能力。例如，一个每秒可以处理 2，000 个请求的程序可能被认为是高性能的，但是如果该程序的速度不能通过添加另一个节点来提高，那么它就是不可伸缩的。

另一方面，即使是低性能的程序也可能是可伸缩的。如果我的程序每秒只处理 1 个请求，但我添加的每个节点都会增加它可以处理的请求数，那么我的程序就是可伸缩的。如果我将这个低性能的程序扩展到 4000 个节点，它将能够处理比以前每秒最多处理 2000 个请求更多的请求。根据整个集群的吞吐量，整个集群(包含 4，000 个节点)现在可能被认为是高性能的，即使其各个部分并不是高性能的。

通常，可伸缩性取决于您并行化任务的能力。并行化是指任务彼此独立运行的能力，即使在其他机器上也是如此。这两个任务越需要相互协调，它们的并行性就越差。在为可伸缩性设计应用程序时，您需要特别注意系统的不同部分需要协调的方式，并致力于最小化或消除这些协调点的影响。

希望您构建的东西既有*高性能(即使对于少量节点)*又有*可伸缩性(因此添加更多节点可以提高性能)。让一个应用程序运行良好是关于寻找慢代码并用快代码替换它，或者重写你的应用程序以不需要慢代码。使应用程序可扩展是关于寻找阻止并行化的*瓶颈*，并用可扩展到多个节点的代码替换这些瓶颈，或者重新设计您的架构，以便瓶颈一开始就不会出现。*

 *本书的重点是可伸缩性，尽管性能也在考虑之列。

### ![../images/487291_1_En_2_Chapter/487291_1_En_2_Figa_HTML.jpg](../images/487291_1_En_2_Chapter/487291_1_En_2_Figa_HTML.jpg)跳过服务器机房

这里有一个有趣的故事，是我在处理服务器机房时不会错过的事情。在 20 世纪 90 年代末，我曾经在一家托管自己服务器的公司担任程序员/系统管理员。这些服务器不在常规的服务器机架上，而是放在金属线架子上。主要的面向外部的服务器在顶层架子上。

我们需要一些额外的驱动器空间，所以我在服务器上安装了一个外部驱动器包。当时，将外部存储连接到服务器的主要模式被称为 SCSI(读作“scuzzy”)，它充满了问题。过了一段时间，服务器访问驱动器包开始出现很多问题，所以我去排除故障。

因为服务器在架子的顶层，所以我站在凳子上操作机器。我花了大约半个小时试图找出问题所在。意识到这发生在我们的主要外部服务器上，所以每一分钟都很重要，因为我们(非常活跃的)网站有问题。

因此，我设法把所有东西从新的驱动器包中移走，然后断开驱动器，把它们带回我的办公室，看看问题出在哪里。然而，我花了太多的时间站在凳子上摆弄电脑，我忘记了，你知道，我是站在凳子上。所以，我抓起驱动器包，走出了房间，或者说，我打算这样做。谢天谢地，我和车手们都没有受伤，但我的自尊心却受到了伤害。

尽管回忆这些故事很有趣，但我很高兴那些日子已经过去了。**